rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* =========================
       Helpers
    ========================= */
    function signedIn() {
      return request.auth != null;
    }

    function userDocExists() {
      return signedIn() && exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    // ✅ FIX: ترجع string دائمًا (بدون null) عشان يختفي تحذير الـ ternary
    function lower(v) {
      return (v is string) ? v.lower() : "";
    }

    // ✅ FIX: ترجع "guest" بدل null + تتحقق أن role string
    function myRole() {
      return (userDocExists()
        && (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role is string))
        ? lower(get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role)
        : "guest";
    }

    function isOwner() { return signedIn() && myRole() == "owner"; }
    function isAdmin() { return signedIn() && (myRole() == "admin" || isOwner()); }
    function isStaff() { return signedIn() && myRole() == "staff"; }
    function isAccountant() { return signedIn() && myRole() == "accountant"; }
    function isClient() { return signedIn() && myRole() == "client"; }

    function isOps() {
      return signedIn() && (isOwner() || isAdmin() || isStaff() || isAccountant());
    }

    /* =========================
       settings
    ========================= */
    match /settings/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    /* =========================
       projects
    ========================= */
    match /projects/{projectId} {
      allow read: if true;
      allow create, delete: if isAdmin();

      allow update: if isAdmin() && !touchingProjectAggregates();

      function touchingProjectAggregates() {
        return request.resource.data.diff(resource.data).changedKeys().hasAny([
          "currentAmount","investorsCount","pendingAmount","updatedAt"
        ]);
      }
    }

    /* =========================
       users  ✅ أهم إصلاح
       - خلّينا create مرن عشان useAuth يقدر ينشئ الوثيقة
       - المستخدم يقرأ/يعدل وثيقته
       - ops يقرأ الجميع (للوحات الإدارة)
    ========================= */
    match /users/{userId} {
      allow read: if (signedIn() && request.auth.uid == userId) || isOps();

      // ✅ create: أقل شروط ممكنة (عشان ما ينهار ensureUserDoc)
      allow create: if signedIn()
        && request.auth.uid == userId
        && request.resource.data.email == request.auth.token.email
        && isValidRoleOnCreate();

      allow update: if isAdmin() || (
        signedIn()
        && request.auth.uid == userId
        && isValidRoleOnUpdate()
      );

      allow delete: if isAdmin();

      function isBootstrapOwnerEmail() {
        return lower(request.auth.token.email) == "nawafaaa0@gmail.com";
      }

      function isValidRoleOnCreate() {
        // يسمح guest/client افتراضياً
        // ويسمح owner فقط لحسابك (bootstrap)
        return !("role" in request.resource.data) ||
          request.resource.data.role in ["guest","client"] ||
          (request.resource.data.role == "owner" && isBootstrapOwnerEmail());
      }

      function isValidRoleOnUpdate() {
        // المستخدم ما يغير role بنفسه (إلا admin)
        // نسمح له بتعديل بياناته فقط
        let keys = request.resource.data.diff(resource.data).changedKeys();
        return !keys.hasAny(["role"]) // المستخدم ممنوع يغيّر role
          && (!keys.hasAny(["email"]) || request.resource.data.email == request.auth.token.email)
          && (!keys.hasAny(["uid"]) || request.resource.data.uid == request.auth.uid);
      }
    }

    /* =========================
       messages ✅ إصلاح list
       - Ops: يشوف الكل
       - Client: يشوف فقط اللي createdByUid == uid (مستوى الأمان الحقيقي يحتاج تغيير مسار البيانات)
       - حالياً نخلي list للـ client مسموح عشان التطبيق يشتغل
    ========================= */
    match /messages/{messageId} {
      allow create: if true;

      allow get, list: if isOps();

      allow get: if isClient() && resource.data.createdByUid == request.auth.uid;

      // ✅ مؤقت لتشغيل الواجهة (احذف شرط request.query.where الغير مدعوم)
      allow list: if isClient();

      allow update: if isOps();
      allow delete: if isAdmin() || isOwner();
    }

    /* =========================
       investments
    ========================= */
    match /investments/{investmentId} {
      allow read: if (signedIn() && request.auth.uid == resource.data.investorUid) || isAdmin() || isOps();

      allow create: if isAdmin() || (
        signedIn()
        && request.resource.data.investorUid == request.auth.uid
        && (request.resource.data.status == "pending_review" || request.resource.data.status == "pending")
        && request.resource.data.amount is number
        && request.resource.data.amount > 0
        && request.resource.data.projectId is string
        && request.resource.data.projectId.size() > 0
        && exists(/databases/$(database)/documents/projects/$(request.resource.data.projectId))
      );

      allow update, delete: if isAdmin();
    }

    /* =========================
       notifications ✅ مهم
       - غالباً “ارسال الطلب” يكتب هنا
    ========================= */
    match /notifications/{id} {
      allow read: if signedIn() && resource.data.uid == request.auth.uid;
      allow create: if isOps();
      allow update, delete: if isAdmin();
    }

    match /admin_users/{docId} {
      allow read, write: if isAdmin();
    }

    match /role_invites/{docId} {
      allow read, write: if isAdmin();
    }

    match /{document=**} {
      allow read, write: if isAdmin();
    }
  }
}
